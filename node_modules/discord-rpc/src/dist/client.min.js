"use strict";function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ownKeys(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,r)}return n}function _objectSpread(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(n,!0).forEach(function(e){_defineProperty(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):ownKeys(n).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var EventEmitter=require("events"),_require=require("timers"),setTimeout=_require.setTimeout,clearTimeout=_require.clearTimeout,fetch=require("node-fetch"),transports=require("./transports"),_require2=require("./constants"),RPCCommands=_require2.RPCCommands,RPCEvents=_require2.RPCEvents,RelationshipTypes=_require2.RelationshipTypes,_require3=require("./util"),getPid=_require3.pid,uuid=_require3.uuid;function subKey(e,t){return"".concat(e).concat(JSON.stringify(t))}var RPCClient=function(){function n(){var o,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,n),(o=_possibleConstructorReturn(this,_getPrototypeOf(n).call(this))).options=e,o.accessToken=null,o.clientId=null,o.application=null,o.user=null;var t=transports[e.transport];if(!t)throw new TypeError("RPC_INVALID_TRANSPORT",e.transport);return o.fetch=function(e,t){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},r=n.data,i=n.query;return fetch("".concat(o.fetch.endpoint).concat(t).concat(i?new URLSearchParams(i):""),{method:e,body:r,headers:{Authorization:"Bearer ".concat(o.accessToken)}}).then(function(t){var n,r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(t.json());case 2:if(n=e.sent,t.ok){e.next=7;break}throw(r=new Error(t.status)).body=n,r;case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}})})},o.fetch.endpoint="https://discord.com/api",o.transport=new t(_assertThisInitialized(o)),o.transport.on("message",o._onRpcMessage.bind(_assertThisInitialized(o))),o._expecting=new Map,o._connectPromise=void 0,o}return _inherits(n,EventEmitter),_createClass(n,[{key:"connect",value:function(r){var i=this;return this._connectPromise||(this._connectPromise=new Promise(function(e,t){i.clientId=r;var n=setTimeout(function(){return t(new Error("RPC_CONNECTION_TIMEOUT"))},2e4);n.unref(),i.once("connected",function(){clearTimeout(n),e(i)}),i.transport.once("close",function(){i._expecting.forEach(function(e){e.reject(new Error("connection closed"))}),i.emit("disconnected"),t(new Error("connection closed"))}),i.transport.connect().catch(t)})),this._connectPromise}},{key:"login",value:function(){var t,n,r,i=arguments;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return n=(t=0<i.length&&void 0!==i[0]?i[0]:{}).clientId,r=t.accessToken,e.next=4,regeneratorRuntime.awrap(this.connect(n));case 4:if(t.scopes){e.next=7;break}return this.emit("ready"),e.abrupt("return",this);case 7:if(r){e.next=11;break}return e.next=10,regeneratorRuntime.awrap(this.authorize(t));case 10:r=e.sent;case 11:return e.abrupt("return",this.authenticate(r));case 12:case"end":return e.stop()}},null,this)}},{key:"request",value:function(r,i,o){var a=this;return new Promise(function(e,t){var n=uuid();a.transport.send({cmd:r,args:i,evt:o,nonce:n}),a._expecting.set(n,{resolve:e,reject:t})})}},{key:"_onRpcMessage",value:function(e){if(e.cmd===RPCCommands.DISPATCH&&e.evt===RPCEvents.READY)e.data.user&&(this.user=e.data.user),this.emit("connected");else if(this._expecting.has(e.nonce)){var t=this._expecting.get(e.nonce),n=t.resolve,r=t.reject;if("ERROR"===e.evt){var i=new Error(e.data.message);i.code=e.data.code,i.data=e.data,r(i)}else n(e.data);this._expecting.delete(e.nonce)}else this.emit(e.evt,e.data)}},{key:"authorize",value:function(){var t,n,r,i,o,a,s,u,c,l,d=arguments;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(t=0<d.length&&void 0!==d[0]?d[0]:{}).scopes,r=t.clientSecret,i=t.rpcToken,o=t.redirectUri,a=t.prompt,r&&!0===i)return e.next=4,regeneratorRuntime.awrap(this.fetch("POST","/oauth2/token/rpc",{data:new URLSearchParams({client_id:this.clientId,client_secret:r})}));e.next=6;break;case 4:s=e.sent,i=s.rpc_token;case 6:return e.next=8,regeneratorRuntime.awrap(this.request("AUTHORIZE",{scopes:n,client_id:this.clientId,prompt:a,rpc_token:i}));case 8:return u=e.sent,c=u.code,e.next=12,regeneratorRuntime.awrap(this.fetch("POST","/oauth2/token",{data:new URLSearchParams({client_id:this.clientId,client_secret:r,code:c,grant_type:"authorization_code",redirect_uri:o})}));case 12:return l=e.sent,e.abrupt("return",l.access_token);case 14:case"end":return e.stop()}},null,this)}},{key:"authenticate",value:function(r){var i=this;return this.request("AUTHENTICATE",{access_token:r}).then(function(e){var t=e.application,n=e.user;return i.accessToken=r,i.application=t,i.user=n,i.emit("ready"),i})}},{key:"getGuild",value:function(e,t){return this.request(RPCCommands.GET_GUILD,{guild_id:e,timeout:t})}},{key:"getGuilds",value:function(e){return this.request(RPCCommands.GET_GUILDS,{timeout:e})}},{key:"getChannel",value:function(e,t){return this.request(RPCCommands.GET_CHANNEL,{channel_id:e,timeout:t})}},{key:"getChannels",value:function(t,n){var r,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this.request(RPCCommands.GET_CHANNELS,{timeout:n,guild_id:t}));case 2:return r=e.sent,i=r.channels,e.abrupt("return",i);case 5:case"end":return e.stop()}},null,this)}},{key:"setCertifiedDevices",value:function(e){return this.request(RPCCommands.SET_CERTIFIED_DEVICES,{devices:e.map(function(e){return{type:e.type,id:e.uuid,vendor:e.vendor,model:e.model,related:e.related,echo_cancellation:e.echoCancellation,noise_suppression:e.noiseSuppression,automatic_gain_control:e.automaticGainControl,hardware_mute:e.hardwareMute}})})}},{key:"setUserVoiceSettings",value:function(e,t){return this.request(RPCCommands.SET_USER_VOICE_SETTINGS,{user_id:e,pan:t.pan,mute:t.mute,volume:t.volume})}},{key:"selectVoiceChannel",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:{},r=n.timeout,i=n.force,o=void 0!==i&&i;return this.request(RPCCommands.SELECT_VOICE_CHANNEL,{channel_id:e,timeout:r,force:o})}},{key:"selectTextChannel",value:function(e,t){var n=(1<arguments.length&&void 0!==t?t:{}).timeout;return this.request(RPCCommands.SELECT_TEXT_CHANNEL,{channel_id:e,timeout:n})}},{key:"getVoiceSettings",value:function(){return this.request(RPCCommands.GET_VOICE_SETTINGS).then(function(e){return{automaticGainControl:e.automatic_gain_control,echoCancellation:e.echo_cancellation,noiseSuppression:e.noise_suppression,qos:e.qos,silenceWarning:e.silence_warning,deaf:e.deaf,mute:e.mute,input:{availableDevices:e.input.available_devices,device:e.input.device_id,volume:e.input.volume},output:{availableDevices:e.output.available_devices,device:e.output.device_id,volume:e.output.volume},mode:{type:e.mode.type,autoThreshold:e.mode.auto_threshold,threshold:e.mode.threshold,shortcut:e.mode.shortcut,delay:e.mode.delay}}})}},{key:"setVoiceSettings",value:function(e){return this.request(RPCCommands.SET_VOICE_SETTINGS,{automatic_gain_control:e.automaticGainControl,echo_cancellation:e.echoCancellation,noise_suppression:e.noiseSuppression,qos:e.qos,silence_warning:e.silenceWarning,deaf:e.deaf,mute:e.mute,input:e.input?{device_id:e.input.device,volume:e.input.volume}:void 0,output:e.output?{device_id:e.output.device,volume:e.output.volume}:void 0,mode:e.mode?{type:e.mode.type,auto_threshold:e.mode.autoThreshold,threshold:e.mode.threshold,shortcut:e.mode.shortcut,delay:e.mode.delay}:void 0})}},{key:"captureShortcut",value:function(n){function r(){return e._subscriptions.delete(t),e.request(RPCCommands.CAPTURE_SHORTCUT,{action:"STOP"})}var e=this,t=subKey(RPCEvents.CAPTURE_SHORTCUT_CHANGE);return this._subscriptions.set(t,function(e){var t=e.shortcut;n(t,r)}),this.request(RPCCommands.CAPTURE_SHORTCUT,{action:"START"}).then(function(){return r})}},{key:"setActivity",value:function(e,t){var n,r,i,o,a=0<arguments.length&&void 0!==e?e:{},s=1<arguments.length&&void 0!==t?t:getPid();if(a.startTimestamp||a.endTimestamp){if((n={start:a.startTimestamp,end:a.endTimestamp}).start instanceof Date&&(n.start=Math.round(n.start.getTime())),n.end instanceof Date&&(n.end=Math.round(n.end.getTime())),2147483647e3<n.start)throw new RangeError("timestamps.start must fit into a unix timestamp");if(2147483647e3<n.end)throw new RangeError("timestamps.end must fit into a unix timestamp")}return(a.largeImageKey||a.largeImageText||a.smallImageKey||a.smallImageText)&&(r={large_image:a.largeImageKey,large_text:a.largeImageText,small_image:a.smallImageKey,small_text:a.smallImageText}),(a.partySize||a.partyId||a.partyMax)&&(i={id:a.partyId},(a.partySize||a.partyMax)&&(i.size=[a.partySize,a.partyMax])),(a.matchSecret||a.joinSecret||a.spectateSecret)&&(o={match:a.matchSecret,join:a.joinSecret,spectate:a.spectateSecret}),this.request(RPCCommands.SET_ACTIVITY,{pid:s,activity:{state:a.state,details:a.details,timestamps:n,assets:r,party:i,secrets:o,buttons:a.buttons,instance:!!a.instance}})}},{key:"clearActivity",value:function(e){var t=0<arguments.length&&void 0!==e?e:getPid();return this.request(RPCCommands.SET_ACTIVITY,{pid:t})}},{key:"sendJoinInvite",value:function(e){return this.request(RPCCommands.SEND_ACTIVITY_JOIN_INVITE,{user_id:e.id||e})}},{key:"sendJoinRequest",value:function(e){return this.request(RPCCommands.SEND_ACTIVITY_JOIN_REQUEST,{user_id:e.id||e})}},{key:"closeJoinRequest",value:function(e){return this.request(RPCCommands.CLOSE_ACTIVITY_JOIN_REQUEST,{user_id:e.id||e})}},{key:"createLobby",value:function(e,t,n){return this.request(RPCCommands.CREATE_LOBBY,{type:e,capacity:t,metadata:n})}},{key:"updateLobby",value:function(e,t){var n=1<arguments.length&&void 0!==t?t:{},r=n.type,i=n.owner,o=n.capacity,a=n.metadata;return this.request(RPCCommands.UPDATE_LOBBY,{id:e.id||e,type:r,owner_id:i&&i.id||i,capacity:o,metadata:a})}},{key:"deleteLobby",value:function(e){return this.request(RPCCommands.DELETE_LOBBY,{id:e.id||e})}},{key:"connectToLobby",value:function(e,t){return this.request(RPCCommands.CONNECT_TO_LOBBY,{id:e,secret:t})}},{key:"sendToLobby",value:function(e,t){return this.request(RPCCommands.SEND_TO_LOBBY,{id:e.id||e,data:t})}},{key:"disconnectFromLobby",value:function(e){return this.request(RPCCommands.DISCONNECT_FROM_LOBBY,{id:e.id||e})}},{key:"updateLobbyMember",value:function(e,t,n){return this.request(RPCCommands.UPDATE_LOBBY_MEMBER,{lobby_id:e.id||e,user_id:t.id||t,metadata:n})}},{key:"getRelationships",value:function(){var t=Object.keys(RelationshipTypes);return this.request(RPCCommands.GET_RELATIONSHIPS).then(function(e){return e.relationships.map(function(e){return _objectSpread({},e,{type:t[e.type]})})})}},{key:"subscribe",value:function(t,n){var r=this;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this.request(RPCCommands.SUBSCRIBE,n,t));case 2:return e.abrupt("return",{unsubscribe:function(){return r.request(RPCCommands.UNSUBSCRIBE,n,t)}});case 3:case"end":return e.stop()}},null,this)}},{key:"destroy",value:function(){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,regeneratorRuntime.awrap(this.transport.close());case 2:case"end":return e.stop()}},null,this)}}]),n}();module.exports=RPCClient;
//# sourceMappingURL=client.min.js.map
